# ARplusR開発メモ

## 工程

- [x] ARマーカーから作られたオブジェクトの座標を取得する(とりあえずTextでリアルタイム表示)
- [x] タップした場所にオブジェクトを生成できるようにする
- [x] オブジェクトにARマーカーが一定以上近づいたらARマーカーオブジェクトの色を変える
- [x] Cubeが直進する用にする
- [x] Cubeが障害物のオブジェクトに近づいたらそれを避けて進むようにする
- [ ] ロボットの実機の様子を見てmicro: bitでBLEするかRaspberry Piを使うかを決める
- [ ] 通信部分を作成
- [ ] 結合テスト
- [ ] 完成

---

## 方向性

  ARマーカーを認識して生成されたオブジェクト(以下仮想ロボットオブジェクト)は最終的には見えないようにする。2020年4月26日わかったことだが、どうやらそれはRendererを無効にすればいいらしい。仮想ロボットオブジェクトのColliderのX, Yの値を大きくし、OnTriggerStayで避ける処理を実行。避けるための動きの方向はUnity上で決定し、それを現実のロボットに配信する形をとる。AR上で現実のラジコンを動かすようなイメージ。

---

## 開発日記

### 2020年4月25日

 工程の最初である**"ARマーカーから作られたオブジェクトの座標を取得する"**はできた。しかし、予想と違って座標は相対的な変化であった。つまり、マーカーを動かすと座標が変化することはもちろんだが,自分自身(AR Camera)が動いても座標が変わった。しかし、結局やりたいことはAR上のオブジェクトとARマーカーを認識して生成されたオブジェクトとの相対的な距離がわかれば良いので、問題はなさそう。ARマーカーの認識が外れるともう一度認識させようとしてもうまく行かないことがほとんどであることがわかった。ARマーカーの認識精度自体は悪くないので、しっかりとカメラで追い続ければ大丈夫だと思われる。

### 2020年4月26日

 姿を消すにはhttps://marunouchi-tech.i-studio.co.jp/2356/によるとRendererをオフにすればいい。なるほど、言われてみればそうだ。仮想ロボットオブジェクトと障害物の接触検知はうまく行かなかった。仮想ロボットオブジェクトはARマーカーを認識すると生成されるオブジェクトで、AR Foundation のAR Tracked Image Managerスクリプトが管理している。Tracked Image PrefabにはCubeを指定している。障害物もほどんど同様のCubeのPrefabで、画面をタップするとAR上で平面と識別された場所に配置される。障害物のIsTriggerをtrueに、仮想ロボットオブジェクトのIsTriggerはfalseのままにして仮想ロボットオブジェクトのOnTriggerStayに

```c#
other.transform.Rotate(new Vector3(15, 30, 45) * Time.deltaTime);
```

としたが動かなかった。Debug.Logに出力することも試したが出力はなかった。OnTriggerEnterに同様にDebug.Logを試したが効果はなかった。(他のシチュエーションでDebug.Logが正常に動くことは確認済み)

### 2020年4月27日

 原因解明に少しずつ近づきつつある。どうやら、2020年4月25日にできたと思われた**"ARマーカーから作られたオブジェクトの座標を取得する"**が実はうまくできていないことがわかった。画面をタップすることで生成されるオブジェクトはカメラの位置を変えても座標が変化しなかった。よく考えてみると、Unityの座標が全てカメラからの相対的な距離として定義されているとは考えにくい。仮想ロボットオブジェクトの座標がカメラからの相対的な位置ならば、カメラの座標と(0, 0, 0)の距離を足せば仮想ロボットオブジェクトの座標を出せるかもしれない。それでも先へ進めそうだが、この先の実装を考えるとできればColliderを使って検知する方法をとりたい。

### 2020年4月28日

*<font color="#FF0461">変更点多量</font>*

 一度強制再起動がかかってUnity上のデータが吹っ飛んだが、改めてやり直したらうまくいった。一定の距離以下になったらそれを検知して障害物がその場で回転させるようにした。デバッグのために一時的に構成を替えてやっている。具体的には、PlaceVirtualRobotなるスクリプトを作成し、ボタンで仮想ロボットを配置できるようにした。これに伴い、"画面をタップしたときに平面を検知していたら障害物を置く"という条件がコンフリクトする用になったので、ARTapToPlaceObjectそのものに変化を加えた。具体的にはUpdate内のif文をコメントアウトした。代わりにCanvas上にボタンを配置し、OnClickにPlaceObjectを登録した。また、ARマーカーから生成されなくなったためにVirtualRobotのスケールが変わったので、0.1→1にした。

 仮想ロボットが直進するようになった。また、一定以上障害物に近づいたら止まるようになった。

 現時点では2つ以上の障害物を避けることができない(1つ目しか認識しない)が、これは原因がわかっている。回避策として、一度回避したオブジェクトを消す方法を考案している。"実装としては仮想ロボットから-Z方向に一定以上離れたオブジェクトは削除する"と"障害物検知の際は`GameObject.FindGameObjectsWithtag`で障害物のリストを取得し、それぞれについて避ける動きを行う"という方向性で実現できそう



また、現在の避け方はUnityの世界でないとできないような動きになっているのでそれを現実的な動きに変更することが必要。一つ考えられるのは検知する距離を更に広くし、RCJの障害物回避のような動き(45°→前進→90°→前進→45°の動き)も案の一つであるが、障害物が密集しているとうまくいかないのでそれも考える必要がある。

### 2020年4月30日(MTGで頂いた意見)

+ SRAMについて勉強。
+ 現実の様子を見ながらマーカーを置いてルンバとかに対するプライベートな空間を明示出たら便利では
+ 床だけでなく壁も認識したいよね
+ ARだけでやる必要もなくて、部屋の空間データを手に入れることができればPC上でオブジェクトを配置して、それをロボットが解釈するようなものもいいよね
+ 発展性もありそうだから知識をつけたいところ
+ SLAMなどのキーワードで調べたり論文を読むようなことも大切
+ やっぱり知識入れないと…
+ あとROSでLiDARのシミュレーションも使えるといいよね(あまり聞き取れなかったのでakiraさんにもう一度聞きに行くといいかも)

### 2020年5月3日

 しばらく何も手をつけていなかった。知識を入れることも大事だけど、手を動かしながら入れたいという欲が出てきてる。実機が無いとシミュレーションに関する勉強をすることに なる。そうするとROSに入門するのがいいと思うけど、Uintyのこれを中途半端な状態にしたままROSにも手を出すのはいかがなものかと思う。でもこのまま何もしないのは一番ダメだし、後々のことを考えてもROSのスキルを持っているのはいいことだし、少し手をつけて見ることにする。

### 2020年5月5日

 先生から頂いた **"ルンバとかに入ってほしくないところにマーキングできると便利かも"** という意見を逆に解釈してみる。つまり、**"入ってほしい→この経路で進んでほしい"**という道標に使える気がする。AR上でマーキングし、ロボットがそれに従うことの面白い点は、**"人間はカメラを覗かないとAR上のオブジェクトが見えない"**という点だと思う。つまり、**ロボットには必要だが、人間にとってはいらない情報を人間視点でロボットに教える事ができ、教えたあとは人間はそれを気にする必要が無い。**それを活かし、人間にはいらない情報であるロボットへの道標をAR上で置くことは意味があるのではないか(自分の方に向かってきたら恐い的な意見もあると思うが…)。

 調べた結果、LiDARセンサは高価であり、SLAMを行うのはコスト的なハードルがあると考えた。Unityならスマホやタブレット端末があればいい。コンピュータは効果かもしれないが、LiDARセンサのように用途が限定されていないため、単純に金額だけで比較することはナンセンスだと言える(いや言えないかも)。

 これを実現するには、

+ 経路指定オブジェクトを配置するための人間の手元にある端末
+ 天井などの高いところに設置され、ロボットを監視する端末

が必要となる。

#### 流れ

1. 名前の通り、経路を指定するための端末
2. ゼロ点を決めるためにARマーカーを認識
3. 経路指定オブジェクト[n]と経路指定オブジェクト[n+1]を直線でつないだ道がロボットが通る経路となる
4. 経路指定オブジェクトを置くとその地点情報(ARマーカーで決められたゼロ点からの座標)がサーバに保存される
5. サーバから監視用端末に経路指定オブジェクトの地点情報を配信
6. 監視用端末でロボットを操作する

#### いいところ

+ 本来ならジャイロセンサやロータリエンコーダなどで回転角を制御しないと方向転換するのは難しいが、Unity上で"ロボットのZ軸が経路指定オブジェクトの方向を向くまで超信地回転"といった命令ができるのでそれらが必要ない
+ AR上で人間視点でしかも直接歩きながら経路を決められる

#### 反対意見

+ 天井から監視できる範囲は限りがある
+ 